# R ARIMAX Model to Snowflake Registry - Demo Setup

This directory contains a complete solution for logging R models to Snowflake's Model Registry using a Python wrapper approach.

## Problem
Customer attempting to log R ARIMAX model encounters `reticulate` package installation errors because:
- Snowflake Model Registry only supports Python models natively
- `reticulate` R package not available in Snowflake conda channel
- R package dependencies incompatible with Python-focused registry

## Solution
Python wrapper class that:
1. Embeds R model (.rds file) and prediction script
2. Executes R via subprocess/Rscript
3. Handles data I/O via CSV interchange
4. Uses SNOWPARK_CONTAINER_SERVICES target platform

## Files

### R Scripts
- **`train_arimax.R`**: Creates synthetic ARIMAX model with exogenous variables
- **`predict_arimax.R`**: Loads model and makes predictions from CSV input
- **`arimax_model_artifact.rds`**: Trained R model (generated by setup)

### Python
- **`r_model_wrapper.py`**: Python wrapper class for R models
  - Embeds model bytes and R script
  - Handles subprocess execution
  - Supports pickling for Model Registry
  
### Notebook
- **`model_logging.ipynb`**: Complete demo workflow
  - Connects to Snowflake
  - Tests model locally
  - Logs to Model Registry
  - Runs inference from registry

### Setup
- **`setup_demo.sh`**: Automated setup script
  - Checks R installation
  - Installs forecast package
  - Trains model
  - Validates predictions

## Quick Start

### 1. Run Setup
```bash
cd /Users/kwells/Desktop/repos/cortex_code_workbook/dj_ml
./setup_demo.sh
```

### 2. Open Notebook
```bash
jupyter notebook model_logging.ipynb
```

Or upload to Snowflake Notebooks and run there.

### 3. Key Configuration
When logging to registry, use:
```python
reg.log_model(
    wrapper,
    model_name="ARIMAX_R_MODEL",
    target_platforms=["SNOWPARK_CONTAINER_SERVICES"],  # Required for R
    conda_dependencies=["r-base>=4.1", "r-forecast"]
)
```

## Architecture

```
┌─────────────────────────────────────────────┐
│  Snowflake Model Registry                   │
│  ┌────────────────────────────────────────┐ │
│  │  Python Wrapper (Pickleable)           │ │
│  │  ├─ model_bytes (embedded .rds)        │ │
│  │  ├─ predict_script (embedded .R)       │ │
│  │  └─ predict() method                   │ │
│  └────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  SPCS Runtime         │
        │  ├─ Python 3.x        │
        │  ├─ R 4.x             │
        │  ├─ forecast package  │
        │  └─ subprocess        │
        └───────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  Data Flow            │
        │  1. Python → CSV      │
        │  2. Rscript execution │
        │  3. CSV → Python      │
        └───────────────────────┘
```

## Why This Works

✅ **No reticulate needed**: Uses subprocess instead of R-Python bridge  
✅ **Self-contained**: Model and script embedded in wrapper  
✅ **Registry compatible**: Python object is fully pickleable  
✅ **SPCS platform**: Supports custom runtime with R  
✅ **Isolated execution**: Each prediction gets clean temp environment

## Alternative Approaches

### 1. R UDF (Recommended for Production)
```sql
CREATE OR REPLACE FUNCTION predict_arimax(exog1 FLOAT, exog2 FLOAT)
RETURNS FLOAT
LANGUAGE R
RUNTIME_VERSION = '4.1'
PACKAGES = ('forecast')
HANDLER = 'predict_handler'
AS $$
predict_handler <- function(exog1, exog2) {
  model <- readRDS("/path/to/model.rds")
  predict(model, xreg=cbind(exog1, exog2))
}
$$;
```

### 2. PMML Export (If Model Supports)
```r
library(pmml)
pmml_model <- pmml(arimax_model)
saveXML(pmml_model, "model.pmml")
```

### 3. External Function
Host R model externally, call via Snowflake External Functions.

## Requirements

### Local Development
- R 4.x or higher
- R package: `forecast`
- Python 3.8+
- snowflake-ml-python >= 1.5.0

### Snowflake
- Snowpark Container Services enabled
- Model Registry access
- CREATE MODEL privilege

## Troubleshooting

### "Rscript command not found"
Install R: `brew install r` (macOS) or `apt-get install r-base` (Linux)

### "forecast package not found"
```r
install.packages('forecast', repos='http://cran.rstudio.com/')
```

### "Target platform WAREHOUSE not supported"
R models require subprocess execution, which only works in SPCS:
```python
target_platforms=["SNOWPARK_CONTAINER_SERVICES"]  # Not ["WAREHOUSE"]
```

### "Model too large (>15GB)"
Use SPCS-only deployment or split model into chunks.

## Support

For issues with:
- **Wrapper approach**: Check subprocess execution and temp file handling
- **Model Registry**: Verify SPCS access and conda dependencies
- **R execution**: Test R scripts locally first with `Rscript`

## Customer Next Steps

1. ✅ Test locally with provided demo
2. Replace `arimax_model_artifact.rds` with actual model
3. Modify `predict_arimax.R` for specific model requirements
4. Adjust wrapper class if different input/output schema needed
5. Deploy to Snowflake Notebooks
6. Log to production Model Registry
